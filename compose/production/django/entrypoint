#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

: "${DATABASE_URL:?Environment variable DATABASE_URL must be set}"

# Extract host and port for healthcheck
POSTGRES_HOST=$(echo "$DATABASE_URL" | sed -E 's|.*://[^@]+@([^:/]+).*|\1|')
POSTGRES_PORT=$(echo "$DATABASE_URL" | sed -E 's|.*:([0-9]+)/.*|\1|')

wait-for-it "${POSTGRES_HOST}:${POSTGRES_PORT}" -t 30

>&2 echo "PostgreSQL is available at ${POSTGRES_HOST}:${POSTGRES_PORT}"

exec "$@"
